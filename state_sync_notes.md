# 状态一致性补丁思路

针对出现 `state=LONG` 但循环仍走买入前置检查的情况，可优先落实以下两点：

1. **循环自检纠偏**：在主循环或位置同步后，若策略处于 LONG 且 `awaiting` 为空，同时本地/远端仓位均低于最小挂单量，应立即调用空仓回调（如 `on_sell_filled(remaining=0)`）将状态恢复为 FLAT，避免继续执行买入逻辑。
2. **同步远端仓位时标记等待卖出**：当同步发现远端已有仓位并触发 `on_buy_filled` 进入 LONG 状态，随后的自动卖出应显式把 `awaiting` 设为 SELL，直到收到卖出成交或拒单回调，这样循环会识别正在卖出，避免回到买入流程。

这两项措施能覆盖“远端有仓位/本地状态漂移”与“自动卖出失败导致等待标志缺失”两个主要卡死原因，通常无需额外补充重试或高频同步即可解决现象。

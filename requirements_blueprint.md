# 需求蓝图：自动化套利程序改造

## 📌 总体目标
- **入口脚本保持不变**：仍由 `Volatility_arbitrage_run.py` 统筹运行流程。
- **核心功能**：完成市场筛选 → 按节奏买入 → 定期监控并卖出 → 资金充足时循环执行。
- **关键要求**：验证连接可用、整合新筛选条件、明确可配置参数、保障日志与异常处理。

## 🧱 模块概览与职责

| 模块/脚本 | 主要职责 | 备注 |
|-----------|----------|------|
| `Volatility_arbitrage_run.py` | 程序入口，串联整套流程 | 耦合关系保持不变 |
| `Volatility_fliter.py`（新建） | 依据设定条件筛选事件/市场 | 从 `poly_filter.py` 提取逻辑并增强 |
| `Volatility_sell.py`（重写） | 集成买入流程 + 盈利监控卖出逻辑 | 结合 `auto_sell_pnl.py` |
| `Volatility_buy.py` | 执行买单 | 确保与入口逻辑协同 |
| `Volatility_arbitrage_main_ws.py` / `Volatility_arbitrage_main_rest.py` | 市场行情与下单服务 | 需验证连接稳定性 |
| `auto_sell_pnl.py` | 参考卖出逻辑与盈亏计算 | 评估后融入 `Volatility_sell.py` |
| `poly_filter.py` | 既有筛选逻辑 | 为新过滤模块提供参考 |

## ⚙️ 关键参数集中管理
> 建议在 `Volatility_fliter.py` 顶部集中配置，并配备清晰注释。

- **关键词白名单 / 黑名单**：来自 `poly_filter.py`，保留原有默认值。
- **成交量阈值**：修改为 `> 10,000`。
- **事件截止时间**：`endDate ≤ 当前时间 + 7 天`（包含边界）。
- **价格可用性/流动性**：`> 0.95`。
- **盈利阈值**：启动程序时可手动输入；未输入则使用默认值。
- **资金阈值**：可用余额 `< 5 USDC` 时暂停买入；恢复后继续执行。
- **买入节奏**：默认每 `20` 秒买入一个符合条件的市场。
- **盈利检查周期**：每 `10` 分钟轮询一次持仓，达到阈值即卖出。

## 🛠️ 功能拆解与实施步骤

### 1. 连接与基础能力验证
- 确认 WebSocket 与 REST 均可成功连接，能获取行情、查询账户、执行买卖。
- 若发现连接封装或调用异常，需修正并补全异常处理 / 重试逻辑。

:::task-stub{title="验证并完善连接与基础买卖功能"}
检查 `Volatility_arbitrage_main_ws.py` 与 REST 接口响应；测试 `Volatility_buy.py`、`Volatility_sell.py`、`auto_sell_pnl.py` 的下单流程；完善错误处理、日志输出与重试机制。:::

### 2. 新建 `Volatility_fliter.py` 并移植/强化筛选逻辑
- 以 `poly_filter.py` 为蓝本，将筛选条件、黑名单等配置集中并显眼可改。
- 替换成交量、截止时间、价格可用性等阈值。
- 提供对外函数供主流程调用，输出符合条件的事件/市场列表。

:::task-stub{title="创建 Volatility_fliter.py 并移植筛选逻辑"}
复制 `poly_filter.py` 的参数结构与函数；调整成交量阈值、事件时间范围、价格可用性条件；保留默认黑名单等；输出筛选结果供主循环使用。:::

### 3. 实现批量买入流程
- 从过滤结果中逐一买入，沿用现有默认最小下单量逻辑。
- 支持程序启动时输入盈利阈值并传递到后续模块。
- 控制买入节奏：每 20 秒一次；余额低于 5 USDC 时暂停。

:::task-stub{title="在 Volatility_sell.py 中实现批量买入流程"}
在 `Volatility_sell.py` 中调用 `Volatility_fliter.py` 获取目标市场；加入循环控制 20 秒间隔下单；查询余额（REST），低于 5 USDC 暂停买入；保存盈利阈值供后续监控使用。:::

### 4. 盈利监控与卖出逻辑
- 每 10 分钟扫描持仓（REST 查询即可），计算盈亏并判断是否达到阈值。
- 满足条件即卖出全部相关持仓。
- 卖出后检查余额，若资金充足则回到买入流程；已卖出的市场如仍符合条件，可再次买入。
- 在 `Volatility_sell.py` 中整合 `auto_sell_pnl.py` 的相关逻辑。

:::task-stub{title="整合 auto_sell_pnl.py 的盈利监控与卖出逻辑"}
融入 `auto_sell_pnl.py` 的盈亏计算与卖出流程；实现 10 分钟轮询；卖出后刷新余额并重新触发买入循环；补充日志、异常处理与状态管理。:::

### 5. 调整入口脚本与整体流程
- 在 `Volatility_arbitrage_run.py` 中串联初始化配置、连接验证、筛选、买入、卖出监控等步骤。
- 保持与原有模块的耦合方式一致；必要时更新调用顺序或参数传递。

:::task-stub{title="调整 Volatility_arbitrage_run.py 与相关模块流程"}
在入口脚本中完成参数输入/初始化 → 连接检测 → 调用筛选模块 → 执行买入循环 → 启动卖出监控；确保模块间接口与流程顺畅。:::

### 6. 配置管理与日志可维护性
- 在关键脚本显眼位置集中配置参数，添加明确注释。
- 强化日志记录：筛选结果、买卖执行、余额变化、异常原因等需详尽可追踪。

:::task-stub{title="梳理参数配置与日志"}
统一配置入口，添加注释说明；更新日志格式，确保筛选结果、买卖决策、资金状态清晰可追踪。:::

## 🔁 运行流程（简版）
1. **启动**：入口脚本读取配置 → 验证连接 → 输入/确认盈利阈值。
2. **筛选**：调用 `Volatility_fliter.py` 获取目标市场列表。
3. **买入循环**：按照节奏买入，余额不足 5 USDC 时暂停。
4. **持仓监控**：每 10 分钟检查盈亏 → 达阈值即卖出。
5. **余额复核**：卖出后检查资金，≥ 5 USDC 则回到步骤 2；否则等待或结束。
6. **重复**：确保已卖出的市场若再次符合条件，可重新进入买入流程。

---

> 如需在后续迭代中逐项勾选已完成的内容，可直接根据以上章节与 task-stub 列表进行追踪。

